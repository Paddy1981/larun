# LARUN Release Automation
# =========================
# Creates GitHub releases with model bundles
#
# Triggers:
# - Push of version tags (v*)
# - Manual dispatch

name: Release

on:
  push:
    tags:
      - 'v*'

  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v2.1.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as prerelease'
        required: false
        default: false
        type: boolean
      draft:
        description: 'Create as draft'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================================================
  # Build Release
  # ==========================================================================
  build:
    name: Build Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyyaml

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi

          # Ensure version starts with 'v'
          if [[ ! "$VERSION" =~ ^v ]]; then
            VERSION="v$VERSION"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Build model bundle
        run: |
          python scripts/bundle_models.py --version ${{ steps.version.outputs.version }}

      - name: Generate changelog
        run: |
          # Get previous tag for changelog
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            python scripts/generate_changelog.py \
              --version ${{ steps.version.outputs.version }} \
              --since $PREV_TAG \
              --release-notes \
              --output dist/RELEASE_NOTES.md
          else
            python scripts/generate_changelog.py \
              --version ${{ steps.version.outputs.version }} \
              --release-notes \
              --output dist/RELEASE_NOTES.md
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: dist/
          retention-days: 7

  # ==========================================================================
  # Run Tests
  # ==========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests
        run: |
          pytest tests/ -v --cov=src --cov-report=xml
        env:
          PYTHONPATH: ${{ github.workspace }}

  # ==========================================================================
  # Validate Models
  # ==========================================================================
  validate:
    name: Validate Models
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate all models
        run: |
          python scripts/validate_models.py --all

  # ==========================================================================
  # Create Release
  # ==========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, test, validate]
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: dist/

      - name: Prepare release files
        run: |
          cd dist

          # List all files
          echo "Release files:"
          ls -la

          # Verify checksums exist
          if [ ! -f checksums.txt ]; then
            echo "Warning: checksums.txt not found"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.version }}
          name: LARUN Models ${{ needs.build.outputs.version }}
          body_path: dist/RELEASE_NOTES.md
          draft: ${{ inputs.draft || false }}
          prerelease: ${{ inputs.prerelease || false }}
          files: |
            dist/larun-models-*.zip
            dist/*.zip
            dist/checksums.txt
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate release summary
        run: |
          echo "# Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for f in dist/*.zip; do
            if [ -f "$f" ]; then
              size=$(du -h "$f" | cut -f1)
              echo "- $(basename $f) ($size)" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # ==========================================================================
  # Notify
  # ==========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [build, release]
    if: always()

    steps:
      - name: Send notification
        if: ${{ needs.release.result == 'success' }}
        run: |
          echo "Release ${{ needs.build.outputs.version }} created successfully!"
          # Add Slack/Discord notification here if configured
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"LARUN ${{ needs.build.outputs.version }} released!"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Report failure
        if: ${{ needs.release.result == 'failure' }}
        run: |
          echo "Release failed!"
          exit 1
